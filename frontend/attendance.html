<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mark Attendance</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    .card-centered { max-width:520px; margin:30px auto; }
    .hint { font-size:0.95rem; color:#666; margin-top:8px; }
  </style>
</head>
<body class="bg-light">

<!-- NAV -->
<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <span class="navbar-brand">HRMS</span>
    <div>
      <a class="btn btn-secondary btn-sm me-2" href="/employee-dashboard.html">Back</a>
      <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<!-- CONTENT -->
<div class="card card-centered shadow-sm p-4">
  <h3 class="mb-3">Mark Attendance</h3>

  <div id="statusBox" class="mb-3"></div>

  <div class="mb-3">
    <label class="form-label">Project</label>
    <input id="project" class="form-control" placeholder="Project name (e.g. Lozier)" />
  </div>

  <div class="mb-3">
    <label class="form-label">Task</label>
    <input id="task" class="form-control" placeholder="Short task description" />
  </div>

  <div class="mb-3">
    <label class="form-label">Hours</label>
    <input id="hours" type="number" step="0.25" min="0" class="form-control" placeholder="Number of hours (e.g. 8)" />
    <div class="hint">You can enter decimals (e.g. 7.5). One submission allowed per day.</div>
  </div>

  <div class="d-grid gap-2">
    <button id="submitBtn" class="btn btn-success btn-lg" onclick="markAttendance()">
      Submit
    </button>
  </div>

  <div class="mt-3 text-center">
    <a href="/employee-dashboard.html">‚Üê Back</a>
  </div>
</div>

<!-- AUTH helper (must exist in /assets/js/auth.js) -->
<script src="/assets/js/auth.js"></script>
<script>
  // Ensure user logged in; require employee role
  requireAuth("employee");
</script>

<script>
(async () => {
  const API = "http://localhost:5000/api";
  const projectEl = document.getElementById("project");
  const taskEl = document.getElementById("task");
  const hoursEl = document.getElementById("hours");
  const submitBtn = document.getElementById("submitBtn");
  const statusBox = document.getElementById("statusBox");

  // get today's date in YYYY-MM-DD and month in YYYY-MM
  function todayDate() {
    return new Date().toISOString().slice(0, 10);
  }
  function monthKey(d) {
    return d.slice(0, 7);
  }

  // Show message area
  function setStatus(html, kind = "info") {
    const color = kind === "ok" ? "success" : kind === "warn" ? "warning" : "info";
    statusBox.innerHTML = `<div class="alert alert-${color}" role="alert">${html}</div>`;
  }

  // Disable form (after submission)
  function disableForm(reason) {
    projectEl.disabled = true;
    taskEl.disabled = true;
    hoursEl.disabled = true;
    submitBtn.disabled = true;
    submitBtn.classList.remove("btn-success");
    submitBtn.classList.add("btn-secondary");
    if (reason) setStatus(reason, "ok");
  }

  // Re-enable (rarely used)
  function enableForm() {
    projectEl.disabled = false;
    taskEl.disabled = false;
    hoursEl.disabled = false;
    submitBtn.disabled = false;
    submitBtn.classList.remove("btn-secondary");
    submitBtn.classList.add("btn-success");
    statusBox.innerHTML = "";
  }

  // On load: check if there's already a timesheet for today
  async function checkAlreadyMarked() {
    try {
      const today = todayDate();
      const res = await fetch(`${API}/timesheet/my?month=${monthKey(today)}`, {
        headers: getAuthHeaders()
      });
      if (!res.ok) {
        // not fatal, just show message
        console.warn("Could not fetch timesheet:", res.status);
        return;
      }

      const rows = await res.json();
      const found = rows.find(r => r.work_date === today);

      if (found) {
        // populate fields from existing timesheet (if available)
        projectEl.value = found.project || "";
        taskEl.value = found.task || "";
        hoursEl.value = found.hours || "";
        disableForm("You already submitted attendance/timesheet for today. If you need to update, use Timesheet page.");
      } else {
        // leave form enabled
        enableForm();
      }
    } catch (err) {
      console.error("checkAlreadyMarked error", err);
    }
  }

  // Submit attendance + timesheet
  window.markAttendance = async function markAttendance() {
    // read inputs first (declare before use)
    const project = projectEl.value.trim();
    const task = taskEl.value.trim();
    const hoursRaw = hoursEl.value;

    if (!project || !task || hoursRaw === "") {
      alert("Please fill project, task and hours.");
      return;
    }

    const hours = Number(hoursRaw);
    if (isNaN(hours) || hours < 0) {
      alert("Please enter a valid hours number.");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.innerText = "Submitting...";

    try {
      const res = await fetch(`${API}/attendance/mark`, {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify({ project, task, hours })
      });

      const data = await res.json();

      if (!res.ok) {
        console.error("Attendance error", data);
        alert(data.message || "Failed to submit");
        submitBtn.disabled = false;
        submitBtn.innerText = "Submit";
        return;
      }

      setStatus("Attendance & timesheet saved for today.", "ok");
      disableForm("Submitted successfully. Use Timesheet page to view or edit (if admin approves).");

      // optional: redirect after a short delay
      // setTimeout(() => window.location.href = "/employee-dashboard.html", 1000);

    } catch (err) {
      console.error("markAttendance error", err);
      alert("Unable to contact server.");
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit";
    }
  };

  // initial check
  await checkAlreadyMarked();

})();
</script>

</body>
</html>
